---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
library(devtools)
install_github("mccormackandrew/mapcan", build_vignettes = TRUE)
```

# Reading in data, removing duplicate variables or concantenating variables, and improving clarity of column names

```{r}
CA <- read_tsv("EventResults.txt", col_names = TRUE, skip = 1)  

CA <- CA %>% 
  rename_with(~ str_remove(.x, "-.*")) %>% 
  mutate(Full_name = str_c(`Given name `, `Surname `, sep = " "), .keep = "unused") %>% 
  select(-`Nom de la circonscription`, -`Type de résultats**`, -`Middle name(s) `, -`Appartenance politique`) %>% 
  filter(`Type of results*` == "validated") %>%  
  select(-`Type of results*`, - `Electoral district number `) %>% 
  mutate(Total_valid_votes = `Total number of ballots cast ` - `Rejected ballots `, .keep = "unused")
```


# Removing full name of political parties with acronyms

```{r}
CA$`Political affiliation`[CA$`Political affiliation` == "NDP-New Democratic Party"] <- "NDP"
CA$`Political affiliation`[CA$`Political affiliation` == "People's Party - PPC"] <- "PPC"
CA$`Political affiliation`[CA$`Political affiliation` == "CFF - Canada's Fourth Front"] <- "CFF"
```


# Ranking candidates by the number of votes they recieved and assigning a variable to winners and losers to each parliamentary riding

```{r}
CA <- CA %>% 
  group_by(`Electoral district name`) %>% 
  mutate(Rank = rank(-`Votes obtained `)) %>% 
  mutate(Winner = if_else(Rank == 1, "Winner", "Loser")) 

### If I want to update % Votes obtained variable I'd put in %>% mutate(`% Votes obtained ` = (`Votes obtained `/Total_valid_votes)*100)

CA$Rank <- as_factor(CA$Rank)

head(CA)
```

# Updating election results if the PPC never existed and their voters instead voted for the Conservatives

```{r}
CA1 <- CA %>%
  group_by(`Electoral district name`) %>% 
  mutate(New_PA = recode(`Political affiliation`, PPC = 'Conservative')) %>% 
  group_by(`Electoral district name`, New_PA) %>% 
  mutate(`New_PA` = str_c(`New_PA`),
            Votes_Obtained = sum(`Votes obtained `)) %>% 
  filter(`Political affiliation` != "PPC") %>% 
  select(- `Political affiliation`, - `Votes obtained `, - `% Votes obtained `, -`Total_valid_votes`) %>% 
  group_by(`Electoral district name`) %>% 
  mutate(Rank = rank(-Votes_Obtained)) %>%
  mutate(Winner = if_else(Rank == 1, "Winner", "Loser")) 

CA1$Rank <- as_factor(CA1$Rank)

head(CA1)
```


# Comparing parliament results of CA (actual) and CA1 (actual but all PPC voters go the Conservatives)


```{r}
CA1 %>% 
  group_by(New_PA) %>% 
  count(Winner) %>% 
  filter(Winner == "Winner") %>% 
  select(-Winner) %>% 
  rename("MP's" = n)
```

```{r}
CA_MPs <- CA %>% 
  group_by(`Political affiliation`) %>% 
  count(Winner) %>% 
  filter(Winner == "Winner") %>% 
  select(-Winner) %>% 
  rename("MP's" = n) 

# The discrepancy between this result and the current Canadian parliament is due to two recounts. Both effect the votes obtained slightly (about a few hundred votes total going either way). One recount at Châteauguay—Lacolle flipped the election result, causing the Liberal candidate to beat the Bloc Quebecois candidate, the first time such a thing has happened since 2008. This is why the Liberals have 160 MPs and the BQ 32 MPs in Canada's parliament. For the purposes of consistency, I will stick with the validated results for all ridings instead of including the judicially recount results for the two ridings that requested them.

head(CA_MPs)
```

# Creating dataset to simulate PPC vote migrating to no one and/or different parties

```{r warning = FALSE, message = FALSE}
CA2 <- CA %>%  
  mutate(PPC_Vote = if_else(`Political affiliation` == "PPC", `Votes obtained `, 0))

CA2$PPC_Vote[CA2$PPC_Vote == 0] <- NA  

CA2 <- CA2 %>% 
  group_by(`Electoral district name`) %>% 
  fill(PPC_Vote, .direction = "updown") %>% 
  mutate_all(~ replace(., is.na(.), 0))

```


```{r}
# Creating test case to create function
# CA2.0 <- CA2 %>% 
#   mutate(`Votes obtained ` = if_else(`Political affiliation` == "Conservative", `Votes obtained ` + 0.5 * PPC_Vote, `Votes obtained `),
#          `Votes obtained ` = if_else(`Political affiliation` == "NDP", `Votes obtained ` + 0.05 * PPC_Vote, `Votes obtained `),
#          `Votes obtained ` = if_else(`Political affiliation` == "Liberal", `Votes obtained ` + 0.05 * PPC_Vote, `Votes obtained `),
#          `Votes obtained ` = if_else(`Political affiliation` == "	Bloc Québécois", `Votes obtained ` + 0.05 * PPC_Vote, `Votes obtained `)) 
# CA2.0$`Votes obtained ` <- round(CA2.0$`Votes obtained `)
# CA2.0  
```

# Function allows users to put in the amount of votes Canadian political parties would have recieved if the PPC had not run

```{r}
No_PPC <- function(Conservative, NDP, Liberal, Bloc_Quebecois){
  CA2 <- CA2 %>% 
    mutate(`Votes obtained ` = if_else(`Political affiliation` == "Conservative", `Votes obtained ` + Conservative * PPC_Vote, `Votes obtained `),
           `Votes obtained ` = if_else(`Political affiliation` == "NDP", `Votes obtained ` + NDP * PPC_Vote, `Votes obtained `),
           `Votes obtained ` = if_else(`Political affiliation` == "Liberal", `Votes obtained ` + Liberal * PPC_Vote, `Votes obtained `),
           `Votes obtained ` = if_else(`Political affiliation` == "	Bloc Québécois", `Votes obtained ` + Bloc_Quebecois * PPC_Vote, `Votes obtained `)) %>% 
    filter(`Political affiliation` != "PPC") %>% 
    select(-PPC_Vote) %>% 
    group_by(`Electoral district name`) %>% 
    mutate(Rank = rank(-`Votes obtained `),
           Winner = if_else(Rank == 1, "Winner", "Loser"),
           `% Votes obtained ` = round(`Votes obtained `/ Total_valid_votes * 100, digits = 2))
  CA2$`Votes obtained ` <- round(CA2$`Votes obtained `)
  CA2
}
```

## Example of Function usage

```{r}
#No_PPC(0.6, 0.05, 0.05, 0.05)
```


# Comparing parliament results of CA (actual) and CA2 (Simulated results of election had PPC not been formed)


```{r}
No_PPC(0.6, 0.05, 0.05, 0.05) %>% 
  group_by(`Political affiliation`) %>% 
  count(Winner) %>% 
  filter(Winner == "Winner") %>% 
  select(-Winner) %>% 
  rename("MP's" = n)
```

```{r}
CA_MPs
```

# Creating a function to calculate number of MP's based on simulated election results

```{r}
calc_mp <- function(dataset) {
  df <- dataset %>% 
  group_by(`Political affiliation`) %>% 
  count(Winner) %>% 
  filter(Winner == "Winner") %>% 
  select(-Winner) %>% 
  rename("MP's" = n)
  df
}
```


## Example of Function usage


```{r}
#calc_mp(No_PPC(1, 0, 0, 0))
```





